<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å¹´æœ«ã‚¸ãƒ£ãƒ³ãƒœè‚‰ãã˜</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
  margin:0;padding:20px;text-align:center;
  background:#fafafa;color:#111;
}
.wrap{max-width:900px;margin:0 auto;}
.card{
  padding:20px;border-radius:20px;border:1px solid #ddd;background:#fff;
  margin-bottom:16px;
}
h1{margin:0 0 10px}

.num{
  font-size:96px;font-weight:900;letter-spacing:6px;
  margin:18px 0;padding:18px 0;border-radius:18px;
  border:2px dashed #bbb;color:#111;
}
.num.final{color:#c00 !important;}

.row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
button{
  padding:14px 18px;font-size:18px;font-weight:800;
  border-radius:14px;border:none;background:#111;color:#fff;
}
button.secondary{background:#555}
button:disabled{opacity:.5}

table{width:100%;border-collapse:collapse;font-size:14px}
th,td{border-bottom:1px solid #eee;padding:8px;text-align:left}
.right{text-align:right}

/* 100å°‚ç”¨æ¼”å‡º */
body.dark{background:#000;color:#c00}
.num.shock{
  color:#f00 !important;
  text-shadow:0 0 26px #f00;
  animation:shake .12s infinite;
}
@keyframes shake{
  0%{transform:translate(0)}
  25%{transform:translate(-3px,2px)}
  50%{transform:translate(3px,-2px)}
  75%{transform:translate(-2px,-3px)}
  100%{transform:translate(0)}
}
</style>
</head>

<body>
<div class="wrap">

<div class="card">
<h1>ğŸ¥© å¹´æœ«ã‚¸ãƒ£ãƒ³ãƒœè‚‰ãã˜ ğŸ¯</h1>

<div id="num" class="num">---</div>

<div class="row">
  <button id="bgmBtn" class="secondary">ğŸµ BGM ON</button>
  <button id="voiceBtn" class="secondary">ğŸ¤ è‚‰ãƒœã‚¤ã‚¹ ON</button>
  <button id="resetBtn" class="secondary">ğŸ§¹ ãƒªã‚»ãƒƒãƒˆ</button>
</div>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>åå‰</th>
<th class="right">æ•°å­—</th>
<th class="right">å·®</th>
<th>åˆ¤å®š</th>
</tr>
</thead>
<tbody id="logBody"></tbody>
</table>
</div>

</div>

<audio id="bgm" loop></audio>

<script>
/* ===== è¨­å®š ===== */
const BGM_FILE='ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ.mp3';
const MIN=0, MAX=100;
const TARGET=29, NEAR=5;
const SPIN_MS=2500;
/* ================= */

const numEl=document.getElementById('num');
const bgmBtn=document.getElementById('bgmBtn');
const voiceBtn=document.getElementById('voiceBtn');
const resetBtn=document.getElementById('resetBtn');
const logBody=document.getElementById('logBody');

const bgm=document.getElementById('bgm');
bgm.src=BGM_FILE;

let bgmOn=false;
let voiceOn=true;
let isRunning=false;

/* ===== AudioContextï¼ˆiPadå¯¾å¿œï¼‰ ===== */
let audioCtx;
function ensureAudio(){
  if(!audioCtx){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  }
  if(audioCtx.state==='suspended'){
    audioCtx.resume();
  }
}
function beep(freq,ms){
  ensureAudio();
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.frequency.value=freq;
  g.gain.value=.05;
  o.connect(g).connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime+ms/1000);
}
function doomSound(){
  ensureAudio();
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.type='sawtooth';
  o.frequency.value=80;
  g.gain.value=.15;
  o.connect(g).connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime+.9);
}

/* ===== è‚‰ãƒœã‚¤ã‚¹ ===== */
function speak(text,rate=1,pitch=1){
  if(!voiceOn) return;
  if(!('speechSynthesis'in window))return;
  const u=new SpeechSynthesisUtterance(text);
  u.lang='ja-JP';
  u.rate=rate;
  u.pitch=pitch;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ===== ãƒœã‚¿ãƒ³ ===== */
bgmBtn.onclick=()=>{
  ensureAudio();
  if(!bgmOn){
    bgm.volume=.3;
    bgm.currentTime=0;
    bgm.play().catch(()=>{});
    bgmBtn.textContent='ğŸµ BGM OFF';
    bgmOn=true;
  }else{
    bgm.pause();
    bgmBtn.textContent='ğŸµ BGM ON';
    bgmOn=false;
  }
};

voiceBtn.onclick=()=>{
  ensureAudio();
  if(!voiceOn){
    voiceOn=true;
    voiceBtn.textContent='ğŸ¤ è‚‰ãƒœã‚¤ã‚¹ ON';
    speak('è‚‰ã€å†èµ·å‹•',0.9,1.1); // ONç¢ºèªç”¨
  }else{
    voiceOn=false;
    speechSynthesis.cancel();
    voiceBtn.textContent='ğŸ¤ è‚‰ãƒœã‚¤ã‚¹ OFF';
  }
};

resetBtn.onclick=()=>{
  logBody.innerHTML='';
};

/* ===== æŠ½é¸ ===== */
function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}

function spin(){
  if(isRunning) return;
  isRunning=true;
  ensureAudio();
  beep(120,30); // unlock

  document.body.classList.remove('dark');
  numEl.className='num';

  const timer=setInterval(()=>{
    numEl.textContent=String(rand(MIN,MAX)).padStart(3,'0');
  },60);

  setTimeout(()=>{
    clearInterval(timer);
    const final=rand(MIN,MAX);
    numEl.textContent=String(final).padStart(3,'0');

    if(final===100){
      if(bgmOn) bgm.pause();
      document.body.classList.add('dark');
      numEl.classList.add('shock');
      doomSound();
      speak('è‚‰ã«ã€è¦‹æ”¾ã•ã‚Œã—è€…â€¦â€¦',0.75,0.6);
    }else if(final===TARGET){
      numEl.classList.add('final');
      speak('ã‚³ãƒ³ã‚°ãƒ©ãƒƒãƒãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ¼ãƒ³ï¼',1.05,1.5);
    }else{
      numEl.classList.add('final');
      speak(['è‚‰ã‚’ç„¦ãŒã™ãªã‚ˆ','é£²ã¿ç‰©ã‚’è‚‰æ±ã«','ãƒ‡ã‚¶ãƒ¼ãƒˆã‚‚è‚‰ã«ã—ã‚'][Math.floor(Math.random()*3)],0.95,0.7);
    }

    const tr=document.createElement('tr');
    tr.innerHTML=`<td>---</td><td class="right">${final}</td><td class="right">${Math.abs(final-TARGET)}</td><td>åˆ¤å®š</td>`;
    logBody.prepend(tr);

    isRunning=false;
  },SPIN_MS);
}

/* ç”»é¢ã‚¿ãƒƒãƒ—ã§æŠ½é¸ï¼ˆå®´ä¼šå‘ã‘ï¼‰ */
document.body.addEventListener('click',spin,{once:false});
</script>
</body>
</html>
